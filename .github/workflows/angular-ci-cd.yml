# ============================================================
# üöÄ CI/CD ‚Äì Angular Frontend (Netlify)
# ============================================================

name: üöÄ CI/CD ‚Äì Angular Frontend (Netlify)

on:
  push:
    branches:
      - main

  workflow_dispatch:

  # Daily at 1:00 AM IST (7:30 PM UTC)
  schedule:
    - cron: "30 19 * * *"

jobs:
  ci-cd-angular:
    runs-on: ubuntu-latest

    env:
      LIVE_URL: https://angular-ecommerce-sitee.netlify.app/

    steps:

      # =====================================================
      # CHECKOUT
      # =====================================================
      - name: üßæ Checkout source code
        uses: actions/checkout@v4

      # =====================================================
      # BUILD TIMESTAMPS (UTC + IST)
      # =====================================================
      - name: ‚è±Ô∏è Generate build timestamps (UTC + IST)
        run: |
          echo "BUILD_TIME_UTC=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "BUILD_TIME_IST=$(TZ=Asia/Kolkata date '+%Y-%m-%d %I:%M:%S %p IST')" >> $GITHUB_ENV

      # =====================================================
      # SETUP NODE
      # =====================================================
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # =====================================================
      # INSTALL DEPENDENCIES
      # =====================================================
      - name: üì¶ Install Dependencies
        run: npm ci

      # =====================================================
      # RUN TESTS
      # =====================================================
      - name: üß™ Run Headless Tests
        run: npm run test:ci || echo "Tests not configured"

      # =====================================================
      # BUILD ANGULAR
      # =====================================================
      - name: üèó Build Production
        run: npm run build:prod

      # =====================================================
      # DEPLOY TO NETLIFY
      # =====================================================
      - name: üöÄ Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: ./dist/e-commerce
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: |
            üöÄ Angular Production Deploy
            üåç ${{ env.LIVE_URL }}
            üîê Commit: ${{ github.sha }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # =====================================================
      # EMAIL ‚Äì SUCCESS (WITH CC WORKING)
      # =====================================================
      - name: üìß Deployment Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Angular Deployment Success"
          to: ${{ secrets.MAIL_TO }}
          cc: ${{ secrets.MAIL_CC }}
          from: ${{ secrets.MAIL_USERNAME }}
          html_body: |
            <h2>üöÄ Angular Frontend Deployed Successfully</h2>
            <table border="1" cellpadding="8">
              <tr><td><b>Application</b></td><td>Angular E-Commerce</td></tr>
              <tr><td><b>Platform</b></td><td>Netlify</td></tr>
              <tr><td><b>Live URL</b></td>
                  <td><a href="${{ env.LIVE_URL }}">${{ env.LIVE_URL }}</a></td></tr>
              <tr><td><b>Commit</b></td><td>${{ github.sha }}</td></tr>
              <tr><td><b>UTC Time</b></td><td>${{ env.BUILD_TIME_UTC }}</td></tr>
              <tr><td><b>IST Time</b></td><td>${{ env.BUILD_TIME_IST }}</td></tr>
              <tr><td><b>Status</b></td>
                  <td style="color:green;"><b>SUCCESS</b></td></tr>
            </table>

      # =====================================================
      # EMAIL ‚Äì FAILURE (WITH CC)
      # =====================================================
      - name: ‚ùå Deployment Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Angular Deployment Failed"
          to: ${{ secrets.MAIL_TO }}
          cc: ${{ secrets.MAIL_CC }}
          from: ${{ secrets.MAIL_USERNAME }}
          html_body: |
            <h2 style="color:red;">‚ùå Angular Deployment Failed</h2>
            <table border="1" cellpadding="8">
              <tr><td><b>Application</b></td><td>Angular E-Commerce</td></tr>
              <tr><td><b>Live URL</b></td>
                  <td><a href="${{ env.LIVE_URL }}">${{ env.LIVE_URL }}</a></td></tr>
              <tr><td><b>UTC Time</b></td><td>${{ env.BUILD_TIME_UTC }}</td></tr>
              <tr><td><b>IST Time</b></td><td>${{ env.BUILD_TIME_IST }}</td></tr>
              <tr><td><b>Status</b></td>
                  <td style="color:red;"><b>FAILED</b></td></tr>
            </table>